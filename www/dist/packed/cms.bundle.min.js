angular.module("starter").controller("CmsViewController",function($location,$log,$rootScope,$scope,$stateParams,Cms,SocialSharing,Url,Places){angular.extend($scope,{is_loading:!0,value_id:$stateParams.value_id,social_sharing_active:!1,use_pull_to_refresh:!0,pull_to_refresh:!1,card_design:!1}),"places"===$stateParams.type&&($scope.use_pull_to_refresh=!1),Cms.setValueId($stateParams.value_id),$scope.loadContent=function(pullToRefresh){switch($stateParams.type){case"places":Places.getPlace($stateParams.page_id).then(function(data){$scope.social_sharing_active=data.social_sharing_active&&$rootScope.isNativeApp,$scope.blocks=data.blocks,$scope.page=data.page,$scope.page&&($scope.template_header="templates/cms/page/l1/view/subheader.html"),$scope.page_title=data.page_title}).then(function(){$scope.is_loading=!1});break;default:Cms.findAll($stateParams.page_id,pullToRefresh).then(function(data){$scope.social_sharing_active=data.social_sharing_active&&$rootScope.isNativeApp,$scope.blocks=data.blocks,$scope.page=data.page,$scope.page&&($scope.template_header="templates/cms/page/l1/view/subheader.html"),$scope.page_title=data.page_title},function(error){$log.error("[CmsViewController] an error occurred while loading CMS",error)}).then(function(){$scope.pull_to_refresh&&($scope.$broadcast("scroll.refreshComplete"),$scope.pull_to_refresh=!1)}).then(function(){$scope.is_loading=!1})}},$scope.pullToRefresh=function(){$scope.pull_to_refresh=!0,$scope.loadContent(!0)},$scope.share=function(){var file;angular.forEach($scope.blocks,function(block){block.gallery&&block.gallery.length>0&&null===file&&(file=block.gallery[0].url)}),SocialSharing.share(void 0,void 0,void 0,file)},$scope.onShowMap=function(block){if(!$rootScope.isNotAvailableOffline()){var params={};block.latitude&&block.longitude?(params.latitude=block.latitude,params.longitude=block.longitude):block.address&&(params.address=encodeURI(block.address)),params.title=block.label,params.value_id=$scope.value_id,$location.path(Url.get("map/mobile_view/index",params))}},$scope.addToContact=function(contact){contact={firstname:$scope.place.title},$scope.place.phone&&(contact.phone=$scope.place.phone),$scope.place.picture&&(contact.image_url=$scope.place.picture),$scope.place.address.street&&(contact.street=$scope.place.address.street),$scope.place.address.postcode&&(contact.postcode=$scope.place.address.postcode),$scope.place.address.city&&(contact.city=$scope.place.address.city),$scope.place.address.state&&(contact.state=$scope.place.address.state),$scope.place.address.country&&(contact.country=$scope.place.address.country),$scope.message=new Message},$scope.loadContent(!1)}).controller("CmsViewMapController",function($log,$scope,$stateParams,Location,Cms){angular.extend($scope,{is_loading:!0,value_id:$stateParams.value_id}),Cms.setValueId($stateParams.value_id),$scope.loadContent=function(){Cms.findBlock($stateParams.block_id,$stateParams.page_id).then(function(data){$scope.block=data.block,$scope.page_title=data.page_title;var marker={title:(data.block.title?data.block.title:data.block.label)+"<br />"+data.block.address,is_centered:!0};data.block.latitude&&data.block.longitude?(marker.latitude=data.block.latitude,marker.longitude=data.block.longitude):marker.address=data.block.address,data.block.picture_url&&(marker.icon={url:data.block.picture_url,width:70,height:44}),Location.getLocation().then(function(position){$scope.createMap(position.coords,marker)},function(){$scope.createMap(null,marker)})},function(error){$log.error("[CmsViewMapController] an error occurred while loading CMS",error)}).then(function(){$scope.is_loading=!1})},$scope.createMap=function(origin,destination){$scope.is_loading=!1,$scope.map_config=origin?{coordinates:{origin:origin,destination:destination}}:{markers:[destination]}},$scope.loadContent()});