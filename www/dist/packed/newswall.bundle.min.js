angular.module("starter").controller("NewswallListController",function($filter,$ionicScrollDelegate,$pwaRequest,$rootScope,$scope,$state,$stateParams,$timeout,$translate,Customer,Location,Modal,Newswall){angular.extend($scope,{is_loading:!0,is_logged_in:Customer.isLoggedIn(),value_id:$stateParams.value_id,collection:[],nearMeCollection:[],recentCollection:[],load_more:!0,can_post:!1,use_pull_refresh:!0,pull_to_refresh:!1,showRecent:!0,picture_fallback:"./img/placeholder/530.272.png",card_design:!1}),Newswall.setValueId($stateParams.value_id),$scope.loadContent=function(){Newswall.findAll($scope.collection.length).then(function(data){if($scope.can_post="fanwall"===data.code,$scope.can_post&&!$scope.tooltip){var collection=[{id:1,name:"Recent",value:!0},{id:2,name:"Near me",value:!1}];$scope.tooltip={collection:collection,current_item:collection[0],button_label:collection[0].name,onItemClicked:function(item){$scope.showTooltip(item)}},$scope.template_header="templates/fanwall/l1/header.html"}data.page_title&&($scope.page_title=data.page_title),$scope.load_more=data.collection.length===data.displayed_per_page,$scope.collection=$scope.collection.concat(data.collection),Newswall.collection=$scope.collection,$scope.collection_chunks=$filter("chunk")($scope.collection,2),$scope.recentCollection=$scope.collection,$rootScope.$broadcast("refreshPageSize")}).then(function(){$scope.is_loading=!1,$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.pullToRefresh=function(){$scope.pull_to_refresh=!0,$scope.load_more=!1,Newswall.findAll(0,!0).then(function(data){if($scope.can_post="fanwall"===data.code,$scope.can_post&&!$scope.tooltip){var collection=[{id:1,name:"Recent",value:!0},{id:2,name:"Near me",value:!1}];$scope.tooltip={collection:collection,current_item:collection[0],button_label:collection[0].name,onItemClicked:function(item){$scope.showTooltip(item)}},$scope.template_header="templates/fanwall/l1/header.html"}data.page_title&&($scope.page_title=data.page_title),$scope.load_more=data.collection.length===data.displayed_per_page,$scope.collection=data.collection,Newswall.collection=$scope.collection,$scope.collection_chunks=$filter("chunk")($scope.collection,2),$scope.recentCollection=$scope.collection}).then(function(){$scope.$broadcast("scroll.refreshComplete"),$scope.pull_to_refresh=!1,$timeout(function(){$scope.load_more=!!$scope.collection.length},500)})},$scope.showItem=function(item){item&&$state.go("newswall-view",{value_id:$scope.value_id,comment_id:item.id})},$scope.loadMore=function(){$scope.showRecent?$scope.loadContent():$scope.getNearComments()},$scope.getNearComments=function(){$rootScope.isNotAvailableOffline()||Location.getLocation().then(function(position){$scope.showRecent||Newswall.findNear($scope.collection.length,position.coords).then(function(data){$scope.load_more=!!data.collection.length,data.collection.length&&($scope.collection=$scope.collection.concat(data.collection),$scope.nearMeCollection=$scope.collection,$rootScope.$broadcast("refreshPageSize"))}).then(function(){$scope.$broadcast("scroll.infiniteScrollComplete"),$scope.is_loading=!1})})},$scope.showTooltip=function(show){$scope.showRecent=show.value,$scope.load_more=!0,show.value?($scope.tooltip.current_item=$scope.tooltip.collection[0],$scope.tooltip.button_label=$scope.tooltip.current_item.name,$scope.collection=$scope.recentCollection):($scope.tooltip.current_item=$scope.tooltip.collection[1],$scope.tooltip.button_label=$scope.tooltip.current_item.name,$scope.nearMeCollection.length?$scope.collection=$scope.nearMeCollection:($scope.collection=[],$scope.is_loading=!0,$scope.getNearComments())),$ionicScrollDelegate.resize()},$scope.goToMap=function(){$rootScope.isNotAvailableOffline()||$state.go("fanwall-map",{value_id:$scope.value_id})},$scope.goToPhotos=function(){$state.go("fanwall-gallery",{value_id:$scope.value_id})},$scope.goToPost=function(){Customer.isLoggedIn()?$state.go("fanwall-edit",{value_id:$scope.value_id}):Customer.loginModal($scope,function(){$scope.is_logged_in=Customer.isLoggedIn(),$scope.goToPost()})},$scope.toggleMenu=function(){$scope.show_menu=!$scope.show_menu},$scope.loadContent()}).controller("NewswallViewController",function(Modal,$pwaRequest,$rootScope,$scope,$state,$stateParams,$timeout,$translate,Application,SB,Comment,Customer,Dialog,Newswall,SocialSharing,Loader){angular.extend($scope,{value_id:$stateParams.value_id,avatars:{},page_title:"",is_logged_in:Customer.isLoggedIn(),social_sharing_active:!1,show_comment_button:!0,show_like_button:!0,card_design:!0}),Newswall.setValueId($stateParams.value_id),$scope.customerAvatar=function(customer_id){if(!(customer_id in $scope.avatars)){var avatar=Customer.getAvatarUrl(customer_id);$scope.avatars[customer_id]=avatar}return $scope.avatars[customer_id]},$scope.loadContent=function(refresh){$scope.is_logged_in=Customer.isLoggedIn(),$scope.is_loading=!0,Newswall.getComment($stateParams.comment_id).then(function(news){$scope.social_sharing_active=news.social_sharing_active&&$rootScope.isNativeApp,$scope.comments=news.answers,$scope.show_flag_button="fanwall"===news.code,$scope.page_title=news.title,$scope.item=news}).then(function(){$scope.is_loading=!1})},$scope.share=function(){var file=$scope.item.picture?$scope.item.picture:void 0;SocialSharing.share($scope.item.cleaned_message,void 0,void 0,void 0,file)},$scope.login=function(){Customer.loginModal($scope,function(){$scope.is_logged_in=Customer.isLoggedIn(),$scope.loadContent(!0)})},$scope.comment=function(){$rootScope.isNotAvailableOffline()||$state.go("newswall-comment",{value_id:$scope.value_id,comment_id:$stateParams.comment_id})},$scope.addLike=function(){$rootScope.isNotAvailableOffline()||(Loader.show(),Newswall.addLike($scope.item.id).then(function(data){data.success&&($scope.item.number_of_likes++,Dialog.alert("",data.message,"OK",-1))},function(data){$scope.showError(data)}).then(function(){Loader.hide()}))},$scope.flagPost=function(){$rootScope.isNotAvailableOffline()||(Loader.show(),Newswall.flagPost($scope.item.id).then(function(data){data.success&&Dialog.alert("",data.message,"OK",-1)},function(data){$scope.showError(data)}).then(function(){Loader.hide()}))},$scope.flagComment=function(answer_id){$rootScope.isNotAvailableOffline()||(Loader.show(),Newswall.flagComment(answer_id).then(function(data){data.success&&Dialog.alert("",data.message,"OK",-1)},function(data){$scope.showError(data)}).then(function(){Loader.hide()}))},$scope.showError=function(data){data&&angular.isDefined(data.message)&&Dialog.alert("Error",data.message,"OK",-1)},$scope.loadContent(),$scope.$on(SB.EVENTS.AUTH.loginSuccess,function(){$scope.loadContent()}),$scope.$on(SB.EVENTS.AUTH.logoutSuccess,function(){$scope.loadContent()})}).controller("NewswallCommentController",function($ionicHistory,$pwaRequest,$rootScope,$scope,$state,$stateParams,$timeout,$translate,$window,Comment,Customer,Dialog,Modal,Newswall){angular.extend($scope,{value_id:$stateParams.value_id,is_logged_in:Customer.isLoggedIn(),comment:{id:$stateParams.comment_id,text:""},card_design:!1}),Newswall.setValueId($stateParams.value_id),$scope.post=function(){$rootScope.isNotAvailableOffline()||_.isObject($scope.comment)&&_.isString($scope.comment.text)&&$scope.comment.text.length>0&&$scope.comment.text.length<1024&&($scope.is_loading=!0,Comment.add($scope.comment).then(function(data){data.success&&($scope.comment.text="",Dialog.alert("",data.message,"OK",-1).then(function(){Newswall.findAll(0,!0).then(function(){$ionicHistory.goBack()})}))}).then(function(){$scope.is_loading=!1}))}}).controller("NewswallGalleryController",function($pwaRequest,$scope,$state,$stateParams,Newswall){angular.extend($scope,{is_loading:!0,value_id:$stateParams.value_id,card_design:!1}),Newswall.setValueId($stateParams.value_id),Newswall.findAllPhotos().then(function(data){$scope.collection=data.collection}).then(function(){$scope.is_loading=!1}),$scope.goToPost=function(item){$state.go("newswall-view",{value_id:$stateParams.value_id,comment_id:item.id})}}).controller("NewswallMapController",function($scope,$pwaRequest,$stateParams,Location,$state,Newswall){angular.extend($scope,{is_loading:!0,value_id:$stateParams.value_id,card_design:!1}),Newswall.setValueId($stateParams.value_id),$scope.loadContent=function(){Newswall.findAllLocation().then(function(data){$scope.page_title=data.page_title,$scope.collection=data.collection;for(var markers=[],i=0;i<$scope.collection.length;i++){var post=$scope.collection[i];if(post.latitude&&post.longitude){var marker={title:post.text,link:$state.href("newswall-view",{value_id:$scope.value_id,comment_id:post.comment_id})};marker.latitude=post.latitude,marker.longitude=post.longitude,post.image&&(marker.icon={url:post.image,width:70,height:44}),markers.push(marker)}}$scope.map_config={markers:markers,bounds_to_marker:!0},$scope.is_loading=!1},function(){$scope.is_loading=!1})},$scope.loadContent()}).controller("NewswallEditController",function(Location,$pwaRequest,$ionicActionSheet,$rootScope,$scope,$state,$stateParams,$timeout,$translate,Application,Dialog,Newswall,Picture,Loader){angular.extend($scope,{value_id:$stateParams.value_id,new_post:{text:null},preview_src:null,readyToPost:!1,card_design:!1}),Newswall.setValueId($stateParams.value_id),$scope.sendPost=function(){$rootScope.isNotAvailableOffline()||($scope.new_post.text?(Loader.show(),Newswall.createComment($scope.new_post.text,$scope.preview_src,$scope.position).then(function(data){Newswall.findAll(0,!0),$state.go("newswall-list",{value_id:$scope.value_id})},function(data){Dialog.alert("Error",data.message,"OK",-1).then(function(){return!0})}).then(function(){Loader.hide()}),$scope.readyToPost=!1):Dialog.alert("Error","You have to enter a text message.","OK",-1))},$scope.takePicture=function(){Picture.takePicture().then(function(response){$scope.preview_src=response.image})},Location.getLocation().then(function(position){$scope.position=position.coords},function(error){$scope.position=null})}),angular.module("starter").factory("Newswall",function($pwaRequest){var factory={value_id:null,displayed_per_page:0,extendedOptions:{},collection:[]};return factory.setValueId=function(value_id){factory.value_id=value_id},factory.setExtendedOptions=function(options){factory.extendedOptions=options},factory.preFetch=function(){factory.findAll()},factory.findAll=function(offset,refresh){return this.value_id?$pwaRequest.get("comment/mobile_list/findall",angular.extend({urlParams:{value_id:this.value_id,offset:offset},refresh:refresh},factory.extendedOptions)):$pwaRequest.reject("[Factory::Newswall.findAll] missing value_id")},factory.findNear=function(offset,position){return this.value_id?$pwaRequest.get("comment/mobile_list/findnear",{urlParams:{value_id:this.value_id,offset:offset,latitude:position.latitude,longitude:position.longitude},cache:!1}):$pwaRequest.reject("[Factory::Newswall.findNear] missing value_id")},factory.findAllPhotos=function(){return this.value_id?$pwaRequest.get("comment/mobile_gallery/findall",{urlParams:{value_id:this.value_id}}):$pwaRequest.reject("[Factory::Newswall.findAllPhotos] missing value_id")},factory.findAllLocation=function(){return this.value_id?$pwaRequest.get("comment/mobile_map/findall",{urlParams:{value_id:this.value_id}}):$pwaRequest.reject("[Factory::Newswall.findAllLocation] missing value_id")},factory.find=function(comment_id){return this.value_id&&void 0!==comment_id?$pwaRequest.get("comment/mobile_view/find",{urlParams:{value_id:this.value_id,comment_id:comment_id}}):$pwaRequest.reject("[Factory::Newswall.find] missing value_id or comment_id")},factory.getComment=function(comment_id){if(!this.value_id)return $pwaRequest.reject("[Factory::Newswall.getComment] missing value_id");var comment=_.get(_.filter(factory.collection,function(comment){return comment.id==comment_id})[0],"embed_payload",!1);return comment?$pwaRequest.resolve(comment):factory.find(comment_id)},factory.insertAnswer=function(comment_id,answer){if(!this.value_id)return $pwaRequest.reject("[Factory::Newswall.insertComment] missing value_id");_.forEach(factory.collection,function(comment){comment.id==comment_id&&comment.hasOwnProperty("embed_payload")&&(comment.embed_payload.hasOwnProperty("answers")?comment.embed_payload.answers.push(answer):comment.embed_payload.answers=[answer],comment.details.comments.text=comment.embed_payload.answers.length)})},factory.addLike=function(comment_id){return this.value_id?$pwaRequest.post("comment/mobile_view/addlike",{data:{comment_id:comment_id,value_id:this.value_id},cache:!1}).then(function(data){return $pwaRequest.get("comment/mobile_list/findall",{urlParams:{value_id:this.value_id},refresh:!0}),data}):$pwaRequest.reject("[Factory::Newswall.addLike] missing value_id")},factory.flagPost=function(comment_id){return this.value_id?$pwaRequest.get("comment/mobile_view/flagpost",{urlParams:{value_id:this.value_id,comment_id:comment_id},cache:!1}):$pwaRequest.reject("[Factory::Newswall.flagPost] missing value_id")},factory.flagComment=function(answer_id){return this.value_id?$pwaRequest.get("comment/mobile_view/flagcomment",{urlParams:{value_id:this.value_id,answer_id:answer_id},cache:!1}):$pwaRequest.reject("[Factory::Newswall.flagComment] missing value_id")},factory.createComment=function(text,image,position){if(!this.value_id)return $pwaRequest.reject("[Factory::Newswall.createComment] missing value_id");var params={};return position&&position.latitude&&position.longitude&&(params.position={latitude:position.latitude,longitude:position.longitude}),$pwaRequest.post("comment/mobile_edit/createv2",{urlParams:{value_id:this.value_id},data:angular.extend(params,{value_id:this.value_id,text:text,image:image}),cache:!1})},factory}),angular.module("starter").factory("Comment",function($pwaRequest){var factory={extendedOptions:{},collection:[]};return factory.setExtendedOptions=function(options){factory.extendedOptions=options},factory.findAll=function(comment_id){return comment_id?$pwaRequest.get("comment/mobile_comment/findall",{urlParams:{comment_id:comment_id}}):$pwaRequest.reject("[Factory::Comment.findAll] missing comment_id")},factory.add=function(comment){return comment.id?$pwaRequest.post("comment/mobile_comment/add",{data:{comment_id:comment.id,text:comment.text},cache:!1}).then(function(data){return $pwaRequest.get("comment/mobile_comment/findall",{urlParams:{comment_id:comment.id},refresh:!0}),data}):$pwaRequest.reject("[Factory::Comment.add] missing comment_id")},factory});